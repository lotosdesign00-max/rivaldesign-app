{"version":3,"file":"track-thrashed-cursor.js","sourceRoot":"","sources":["../../../src/autocapture/track-thrashed-cursor.ts"],"names":[],"mappings":"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","sourcesContent":["import { BrowserClient, ElementInteractionsOptions, Observable } from '@amplitude/analytics-core';\nimport { AllWindowObservables } from '../frustration-plugin';\nimport { AMPLITUDE_THRASHED_CURSOR_EVENT } from '../constants';\nimport { isUrlAllowed } from '../helpers';\n\ntype Position = {\n  x: number;\n  y: number;\n};\n\nenum Direction {\n  INCREASING = 'increasing',\n  DECREASING = 'decreasing',\n}\n\nenum Axis {\n  X = 'x',\n  Y = 'y',\n}\n\nexport const createMouseDirectionChangeObservable = ({\n  allWindowObservables,\n}: {\n  allWindowObservables: AllWindowObservables;\n}): Observable<Axis> => {\n  const { mouseMoveObservable } = allWindowObservables;\n  return new Observable<Axis>((observer) => {\n    let lastPosition: Position | null = null;\n    let xDirection: Direction | null = null;\n    let yDirection: Direction | null = null;\n    return mouseMoveObservable.subscribe((event) => {\n      const currentPosition = { x: event.clientX, y: event.clientY };\n      if (lastPosition === null) {\n        lastPosition = currentPosition;\n        return;\n      }\n      if (currentPosition.x > lastPosition.x) {\n        if (xDirection === Direction.DECREASING) {\n          observer.next(Axis.X);\n        }\n        xDirection = Direction.INCREASING;\n      } else if (currentPosition.x < lastPosition.x) {\n        if (xDirection === Direction.INCREASING) {\n          observer.next(Axis.X);\n        }\n        xDirection = Direction.DECREASING;\n      }\n\n      if (currentPosition.y > lastPosition.y) {\n        if (yDirection === Direction.DECREASING) {\n          observer.next(Axis.Y);\n        }\n        yDirection = Direction.INCREASING;\n      } else if (currentPosition.y < lastPosition.y) {\n        if (yDirection === Direction.INCREASING) {\n          observer.next(Axis.Y);\n        }\n        yDirection = Direction.DECREASING;\n      }\n      lastPosition = currentPosition;\n    });\n  });\n};\n\ntype DirectionChangeSeries = {\n  // number of direction changes to be considered a thrashed cursor\n  changesThreshold: number;\n  // timestamps of direction changes (limited to \"changesThreshold\" to avoid memory leaks)\n  changes: number[];\n  // window duration in milliseconds\n  thresholdMs: number;\n  // when the series of direction   changes started\n  startTime?: number;\n};\n\nfunction addDirectionChange(directionChangeSeries: DirectionChangeSeries) {\n  const now = +Date.now();\n\n  directionChangeSeries.startTime = directionChangeSeries.startTime || now;\n\n  // add this direction change to the series (fixed length array to avoid memory leaks)\n  const { changes, changesThreshold } = directionChangeSeries;\n  changes.push(now);\n  if (changes.length > changesThreshold) changes.shift();\n}\n\n// checks if there are enough direction changes within window + threshold\n// for it to be considered a thrashed cursor\nfunction isThrashedCursor(directionChanges: DirectionChangeSeries): boolean {\n  const { changes, changesThreshold, thresholdMs } = directionChanges;\n  if (changes.length < changesThreshold) return false;\n  const delta = changes[changes.length - 1] - changes[0];\n  return delta < thresholdMs;\n}\n\nfunction resetDirectionChangeSeries(directionChangeSeries: DirectionChangeSeries) {\n  directionChangeSeries.changes = [];\n  directionChangeSeries.startTime = undefined;\n}\n\n// if the time between first and last change is greater than the threshold,\n// shift the window to the right until it is below the threshold\nfunction adjustWindow(directionChanges: DirectionChangeSeries) {\n  const { changes, thresholdMs } = directionChanges;\n\n  // find the first change that is within the threshold\n  let leftPtr = 0;\n  const lastChange = changes[changes.length - 1];\n  for (; leftPtr < changes.length; leftPtr++) {\n    const delta = lastChange - changes[leftPtr];\n    if (delta < thresholdMs) {\n      break;\n    }\n  }\n  if (leftPtr === 0) return;\n\n  directionChanges.startTime = changes[leftPtr];\n  directionChanges.changes.splice(0, leftPtr);\n}\n\nfunction getPendingThrashedCursor(\n  directionChangesX: DirectionChangeSeries,\n  directionChangesY: DirectionChangeSeries,\n): number | undefined {\n  let startTime = undefined;\n  if (isThrashedCursor(directionChangesX)) {\n    startTime = directionChangesX.startTime;\n  }\n  if (isThrashedCursor(directionChangesY)) {\n    const startTimeY = directionChangesY.startTime;\n    if (startTimeY && (!startTime || startTimeY < startTime)) {\n      startTime = startTimeY;\n    }\n  }\n  return startTime;\n}\n\nconst DEFAULT_THRESHOLD = 10;\nconst DEFAULT_WINDOW_MS = 2_000;\n\nexport const createThrashedCursorObservable = ({\n  mouseDirectionChangeObservable,\n  directionChanges = DEFAULT_THRESHOLD,\n  thresholdMs = DEFAULT_WINDOW_MS,\n}: {\n  mouseDirectionChangeObservable: Observable<Axis>;\n  directionChanges?: number;\n  thresholdMs?: number;\n}): Observable<number> => {\n  return new Observable<number>((observer) => {\n    const xDirectionChanges: DirectionChangeSeries = { changes: [], changesThreshold: directionChanges, thresholdMs };\n    const yDirectionChanges: DirectionChangeSeries = { changes: [], changesThreshold: directionChanges, thresholdMs };\n    let pendingThrashedCursor: number | undefined = undefined;\n    let timer: ReturnType<typeof setTimeout> | null = null;\n\n    function emitPendingThrashedCursor() {\n      if (pendingThrashedCursor !== undefined) {\n        observer.next(pendingThrashedCursor);\n        pendingThrashedCursor = undefined;\n\n        // reset window\n        if (timer !== null) clearTimeout(timer);\n        resetDirectionChangeSeries(xDirectionChanges);\n        resetDirectionChangeSeries(yDirectionChanges);\n      }\n    }\n\n    return mouseDirectionChangeObservable.subscribe((axis) => {\n      if (timer !== null) clearTimeout(timer);\n      addDirectionChange(axis === Axis.X ? xDirectionChanges : yDirectionChanges);\n\n      const nextPendingThrashedCursor = getPendingThrashedCursor(xDirectionChanges, yDirectionChanges);\n      if (nextPendingThrashedCursor) {\n        // if we're in a thrashed cursor window, debounce it for \"thresholdMs\" duration\n        // this is so that we do not restart the window if more direction changes are\n        // detected in this series\n        pendingThrashedCursor = pendingThrashedCursor || nextPendingThrashedCursor;\n        timer = setTimeout(() => {\n          emitPendingThrashedCursor();\n          timer = null;\n        }, thresholdMs);\n      } else {\n        emitPendingThrashedCursor();\n      }\n\n      adjustWindow(xDirectionChanges);\n      adjustWindow(yDirectionChanges);\n\n      /* istanbul ignore next */\n      return () => {\n        /* istanbul ignore if */\n        if (timer !== null) {\n          clearTimeout(timer);\n          timer = null;\n        }\n      };\n    });\n  });\n};\n\nexport const trackThrashedCursor = ({\n  amplitude,\n  options,\n  allObservables,\n  directionChanges = DEFAULT_THRESHOLD,\n  thresholdMs = DEFAULT_WINDOW_MS,\n}: {\n  amplitude: BrowserClient;\n  options: ElementInteractionsOptions;\n  allObservables: AllWindowObservables;\n  directionChanges?: number;\n  thresholdMs?: number;\n}) => {\n  const mouseDirectionChangeObservable = createMouseDirectionChangeObservable({ allWindowObservables: allObservables });\n  const thrashedCursorObservable = createThrashedCursorObservable({\n    mouseDirectionChangeObservable,\n    directionChanges,\n    thresholdMs,\n  });\n  return thrashedCursorObservable.subscribe((time) => {\n    if (!isUrlAllowed(options)) {\n      return;\n    }\n    amplitude.track(AMPLITUDE_THRASHED_CURSOR_EVENT, undefined, { time });\n  });\n};\n"]}