{"version":3,"file":"messenger.js","sourceRoot":"","sources":["../../../src/libs/messenger.ts"],"names":[],"mappings":";;;AAAA,0BAA0B;AAC1B,0CAA0C;AAC1C,0CAAsH;AAGtH,sCAAqC;AA6DrC;;GAEG;AACH,IAAM,oBAAoB,GAAG,8BAAuC,CAAC;AAErE;;;;;;GAMG;AACH,SAAgB,mBAAmB,CACjC,SAA8B,EAC9B,OAKC;IAED,qDAAqD;IACrD,IAAM,OAAO,GAAG,SAA+C,CAAC;IAChE,IAAI,OAAO,CAAC,oBAAoB,CAAC,KAAK,IAAI,EAAE;QAC1C,OAAO;KACR;IACD,OAAO,CAAC,oBAAoB,CAAC,GAAG,IAAI,CAAC;IAE7B,IAAA,aAAa,GAAsE,OAAO,cAA7E,EAAE,mBAAmB,GAAiD,OAAO,oBAAxD,EAAE,oBAAoB,GAA2B,OAAO,qBAAlC,EAAE,oBAAoB,GAAK,OAAO,qBAAZ,CAAa;IAEnG,IAAI,sCAAsC,GAAQ,IAAI,CAAC;IAEvD,IAAM,QAAQ,GAAG,UAAC,IAAyB;QACzC,SAAS,CAAC,MAAM,CAAC,EAAE,MAAM,EAAE,kBAAkB,EAAE,IAAI,MAAA,EAAE,CAAC,CAAC;IACzD,CAAC,CAAC;IAEF,IAAM,OAAO,GAAG,UAAC,IAAY,EAAE,UAA4C;QACzE,IAAI,IAAI,KAAK,uBAAuB,EAAE;YACpC,SAAS,CAAC,MAAM,CAAC,EAAE,MAAM,EAAE,6BAA6B,EAAE,IAAI,EAAE,UAAU,EAAE,CAAC,CAAC;SAC/E;aAAM,IAAI,IAAI,KAAK,gBAAgB,EAAE;YACpC,SAAS,CAAC,MAAM,CAAC,EAAE,MAAM,EAAE,sBAAsB,EAAE,IAAI,EAAE,UAAU,EAAE,CAAC,CAAC;SACxE;IACH,CAAC,CAAC;IAEF,SAAS,CAAC,qBAAqB,CAC7B,oCAAoC,EACpC,UAAC,UAA+C;QAC9C,SAAS;aACN,cAAc,CAAC,wDAA4C,CAAC;aAC5D,IAAI,CAAC;;YACJ,2BAA2B;YAC3B,sCAAsC,GAAG,MAAC,MAAc,aAAd,MAAM,uBAAN,MAAM,CAAU,8BAA8B,uDAAG;gBACzF,gBAAgB,EAAE,aAAa,CAAC,gBAAgB;gBAChD,mBAAmB,EAAE,UAAC,OAAgB;oBACpC,IAAI,mBAAmB,EAAE;wBACvB,OAAO,mBAAmB,CAAC,CAAA,UAAU,aAAV,UAAU,uBAAV,UAAU,CAAE,UAAU,KAAI,OAAO,EAAE,OAAO,CAAC,CAAC;qBACxE;oBACD,OAAO,IAAI,CAAC;gBACd,CAAC;gBACD,OAAO,SAAA;gBACP,QAAQ,UAAA;gBACR,oBAAoB,EAAE,oDAAwC;gBAC9D,SAAS,WAAA;gBACT,oBAAoB,sBAAA;gBACpB,oBAAoB,sBAAA;gBACpB,yBAAyB,EAAE,aAAa,CAAC,yBAAyB;gBAClE,aAAa,eAAA;gBACb,WAAW,EAAE;oBACX,WAAW,EAAE;wBACX,OAAO,EAAE,iBAAO;qBACjB;iBACF;aACF,CAAC,CAAC;YACH,SAAS,CAAC,MAAM,CAAC,EAAE,MAAM,EAAE,iBAAiB,EAAE,CAAC,CAAC;QAClD,CAAC,CAAC;aACD,KAAK,CAAC;;YACL,MAAA,SAAS,CAAC,MAAM,0CAAE,IAAI,CAAC,8CAA8C,CAAC,CAAC;QACzE,CAAC,CAAC,CAAC;IACP,CAAC,CACF,CAAC;IAEF,SAAS,CAAC,qBAAqB,CAAC,+BAA+B,EAAE;;QAC/D,2BAA2B;QAC3B,MAAA,sCAAsC,aAAtC,sCAAsC,uBAAtC,sCAAsC,CAAE,KAAK,sFAAI,CAAC;IACpD,CAAC,CAAC,CAAC;AACL,CAAC;AAzED,kDAyEC","sourcesContent":["/* istanbul ignore file */\n/* eslint-disable no-restricted-globals */\nimport { AMPLITUDE_VISUAL_TAGGING_SELECTOR_SCRIPT_URL, AMPLITUDE_VISUAL_TAGGING_HIGHLIGHT_CLASS } from '../constants';\nimport type { BaseWindowMessenger } from '@amplitude/analytics-core';\nimport { ActionType } from '@amplitude/analytics-core';\nimport { VERSION } from '../version';\nimport { DataExtractor } from '../data-extractor';\n\nexport type Action =\n  | 'ping'\n  | 'pong'\n  | 'page-loaded'\n  | 'selector-loaded'\n  | 'initialize-visual-tagging-selector'\n  | 'close-visual-tagging-selector'\n  | 'element-selected'\n  | 'track-selector-mode-changed'\n  | 'track-selector-moved'\n  | 'initialize-background-capture'\n  | 'close-background-capture'\n  | 'background-capture-loaded'\n  | 'background-capture-complete';\n\ninterface InitializeVisualTaggingSelectorData {\n  actionType: ActionType;\n}\n\ninterface ElementSelectedData {\n  '[Amplitude] Element Hierarchy'?: string;\n  '[Amplitude] Element Tag'?: string;\n  '[Amplitude] Element Text'?: string;\n  '[Amplitude] Page URL'?: string;\n  elementScreenshot?: Blob;\n}\n\ninterface TrackSelectorModeChangedData {\n  newMode: string;\n  pageUrl?: string;\n}\n\ninterface TrackSelectorMovedData {\n  newEditorLocation: string;\n  pageUrl?: string;\n}\n\nexport type ActionData = {\n  ping: null | undefined;\n  pong: null | undefined;\n  'page-loaded': null | undefined;\n  'selector-loaded': null | undefined;\n  'initialize-visual-tagging-selector': InitializeVisualTaggingSelectorData | null | undefined;\n  'close-visual-tagging-selector': null | undefined;\n  'element-selected': ElementSelectedData;\n  'track-selector-mode-changed': TrackSelectorModeChangedData;\n  'track-selector-moved': TrackSelectorMovedData;\n  'initialize-background-capture': null | undefined;\n  'close-background-capture': null | undefined;\n  'background-capture-loaded': null | undefined;\n  'background-capture-complete': { [key: string]: string | null };\n};\n\nexport interface Message<A extends Action> {\n  action: A;\n  data?: ActionData[A];\n}\n\n/**\n * Brand key to track whether visual tagging has been enabled on a messenger.\n */\nconst VISUAL_TAGGING_BRAND = '__AMPLITUDE_VISUAL_TAGGING__' as const;\n\n/**\n * Enable visual tagging on a messenger instance.\n * The first call registers the handlers; subsequent calls are no-ops.\n *\n * @param messenger - The messenger to enable visual tagging on\n * @param options - Visual tagging configuration\n */\nexport function enableVisualTagging(\n  messenger: BaseWindowMessenger,\n  options: {\n    isElementSelectable?: (action: InitializeVisualTaggingSelectorData['actionType'], element: Element) => boolean;\n    cssSelectorAllowlist?: string[];\n    actionClickAllowlist?: string[];\n    dataExtractor: DataExtractor;\n  },\n): void {\n  // Idempotency guard â€” works across bundle boundaries\n  const branded = messenger as unknown as Record<string, unknown>;\n  if (branded[VISUAL_TAGGING_BRAND] === true) {\n    return;\n  }\n  branded[VISUAL_TAGGING_BRAND] = true;\n\n  const { dataExtractor, isElementSelectable, cssSelectorAllowlist, actionClickAllowlist } = options;\n\n  let amplitudeVisualTaggingSelectorInstance: any = null;\n\n  const onSelect = (data: ElementSelectedData) => {\n    messenger.notify({ action: 'element-selected', data });\n  };\n\n  const onTrack = (type: string, properties: { [key: string]: string | null }) => {\n    if (type === 'selector-mode-changed') {\n      messenger.notify({ action: 'track-selector-mode-changed', data: properties });\n    } else if (type === 'selector-moved') {\n      messenger.notify({ action: 'track-selector-moved', data: properties });\n    }\n  };\n\n  messenger.registerActionHandler(\n    'initialize-visual-tagging-selector',\n    (actionData: InitializeVisualTaggingSelectorData) => {\n      messenger\n        .loadScriptOnce(AMPLITUDE_VISUAL_TAGGING_SELECTOR_SCRIPT_URL)\n        .then(() => {\n          // eslint-disable-next-line\n          amplitudeVisualTaggingSelectorInstance = (window as any)?.amplitudeVisualTaggingSelector?.({\n            getEventTagProps: dataExtractor.getEventTagProps,\n            isElementSelectable: (element: Element) => {\n              if (isElementSelectable) {\n                return isElementSelectable(actionData?.actionType || 'click', element);\n              }\n              return true;\n            },\n            onTrack,\n            onSelect,\n            visualHighlightClass: AMPLITUDE_VISUAL_TAGGING_HIGHLIGHT_CLASS,\n            messenger,\n            cssSelectorAllowlist,\n            actionClickAllowlist,\n            extractDataFromDataSource: dataExtractor.extractDataFromDataSource,\n            dataExtractor,\n            diagnostics: {\n              autocapture: {\n                version: VERSION,\n              },\n            },\n          });\n          messenger.notify({ action: 'selector-loaded' });\n        })\n        .catch(() => {\n          messenger.logger?.warn('Failed to initialize visual tagging selector');\n        });\n    },\n  );\n\n  messenger.registerActionHandler('close-visual-tagging-selector', () => {\n    // eslint-disable-next-line\n    amplitudeVisualTaggingSelectorInstance?.close?.();\n  });\n}\n"]}