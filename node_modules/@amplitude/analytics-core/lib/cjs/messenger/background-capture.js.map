{"version":3,"file":"background-capture.js","sourceRoot":"","sources":["../../../src/messenger/background-capture.ts"],"names":[],"mappings":";;;AAEA,yCAAsE;AAEtE;;;GAGG;AACH,IAAM,gBAAgB,GAAG,kCAA2C,CAAC;AAErE;;;;;;;GAOG;AACH,SAAgB,uBAAuB,CAAC,SAA8B,EAAE,OAAgC;;IACtG,kFAAkF;IAClF,IAAM,OAAO,GAAG,SAA+C,CAAC;IAChE,IAAI,OAAO,CAAC,gBAAgB,CAAC,KAAK,IAAI,EAAE;QACtC,OAAO;KACR;IACD,OAAO,CAAC,gBAAgB,CAAC,GAAG,IAAI,CAAC;IAEjC,IAAM,SAAS,GAAG,MAAA,OAAO,aAAP,OAAO,uBAAP,OAAO,CAAE,SAAS,mCAAI,mDAAuC,CAAC;IAChF,IAAI,yBAAyB,GAAQ,IAAI,CAAC;IAE1C,IAAM,mBAAmB,GAAG,UAAC,IAAY,EAAE,qBAAgE;;QACzG,IAAI,IAAI,KAAK,6BAA6B,EAAE;YAC1C,MAAA,MAAA,SAAS,CAAC,MAAM,0CAAE,KAAK,mDAAG,6BAA6B,CAAC,CAAC;YACzD,SAAS,CAAC,MAAM,CAAC,EAAE,MAAM,EAAE,6BAA6B,EAAE,IAAI,EAAE,qBAAqB,EAAE,CAAC,CAAC;SAC1F;IACH,CAAC,CAAC;IAEF,SAAS,CAAC,qBAAqB,CAAC,+BAA+B,EAAE;;QAC/D,MAAA,MAAA,SAAS,CAAC,MAAM,0CAAE,KAAK,mDAAG,mDAAmD,CAAC,CAAC;QAC/E,IAAM,WAAW,GAAG,IAAI,GAAG,CAAC,SAAS,EAAE,SAAS,CAAC,QAAQ,CAAC,CAAC,QAAQ,EAAE,CAAC;QAEtE,SAAS;aACN,cAAc,CAAC,WAAW,CAAC;aAC3B,IAAI,CAAC;;YACJ,MAAA,MAAA,SAAS,CAAC,MAAM,0CAAE,KAAK,mDAAG,6CAA6C,CAAC,CAAC;YACzE,2BAA2B;YAC3B,yBAAyB,GAAG,iEAAiE,CAAC,MAC5F,MACD,aADC,MAAM,uBAAN,MAAM,CACL,0BAA0B,uDAAG;gBAC9B,SAAS,WAAA;gBACT,mBAAmB,qBAAA;aACpB,CAAC,CAAC;YACH,SAAS,CAAC,MAAM,CAAC,EAAE,MAAM,EAAE,2BAA2B,EAAE,CAAC,CAAC;QAC5D,CAAC,CAAC;aACD,KAAK,CAAC;;YACL,MAAA,SAAS,CAAC,MAAM,0CAAE,IAAI,CAAC,yCAAyC,CAAC,CAAC;QACpE,CAAC,CAAC,CAAC;IACP,CAAC,CAAC,CAAC;IAEH,SAAS,CAAC,qBAAqB,CAAC,0BAA0B,EAAE;;QAC1D,yGAAyG;QACzG,MAAA,yBAAyB,aAAzB,yBAAyB,uBAAzB,yBAAyB,CAAE,KAAK,yEAAI,CAAC;QACrC,yBAAyB,GAAG,IAAI,CAAC;IACnC,CAAC,CAAC,CAAC;AACL,CAAC;AA7CD,0DA6CC","sourcesContent":["/* eslint-disable no-restricted-globals */\nimport type { BaseWindowMessenger } from './base-window-messenger';\nimport { AMPLITUDE_BACKGROUND_CAPTURE_SCRIPT_URL } from './constants';\n\n/**\n * Brand key set on the messenger instance to track whether background capture\n * has been enabled.\n */\nconst BG_CAPTURE_BRAND = '__AMPLITUDE_BACKGROUND_CAPTURE__' as const;\n\n/**\n * Enable background capture on a messenger instance.\n * Plugins can call this on a shared messenger instance.\n * The first call registers the handlers; subsequent calls are no-ops.\n *\n * @param messenger - The messenger to enable background capture on\n * @param options.scriptUrl - Override the background capture script URL (optional)\n */\nexport function enableBackgroundCapture(messenger: BaseWindowMessenger, options?: { scriptUrl?: string }): void {\n  // Check the brand on the messenger object itself â€” works across bundle boundaries\n  const branded = messenger as unknown as Record<string, unknown>;\n  if (branded[BG_CAPTURE_BRAND] === true) {\n    return;\n  }\n  branded[BG_CAPTURE_BRAND] = true;\n\n  const scriptUrl = options?.scriptUrl ?? AMPLITUDE_BACKGROUND_CAPTURE_SCRIPT_URL;\n  let backgroundCaptureInstance: any = null;\n\n  const onBackgroundCapture = (type: string, backgroundCaptureData: { [key: string]: string | number | null }) => {\n    if (type === 'background-capture-complete') {\n      messenger.logger?.debug?.('Background capture complete');\n      messenger.notify({ action: 'background-capture-complete', data: backgroundCaptureData });\n    }\n  };\n\n  messenger.registerActionHandler('initialize-background-capture', () => {\n    messenger.logger?.debug?.('Initializing background capture (external script)');\n    const resolvedUrl = new URL(scriptUrl, messenger.endpoint).toString();\n\n    messenger\n      .loadScriptOnce(resolvedUrl)\n      .then(() => {\n        messenger.logger?.debug?.('Background capture script loaded (external)');\n        // eslint-disable-next-line\n        backgroundCaptureInstance = /* istanbul ignore next -- window is always defined in browser */ (\n          window as any\n        )?.amplitudeBackgroundCapture?.({\n          messenger,\n          onBackgroundCapture,\n        });\n        messenger.notify({ action: 'background-capture-loaded' });\n      })\n      .catch(() => {\n        messenger.logger?.warn('Failed to initialize background capture');\n      });\n  });\n\n  messenger.registerActionHandler('close-background-capture', () => {\n    // eslint-disable-next-line @typescript-eslint/no-unsafe-member-access, @typescript-eslint/no-unsafe-call\n    backgroundCaptureInstance?.close?.();\n    backgroundCaptureInstance = null;\n  });\n}\n"]}